<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <title>5.2.&nbsp;K3 Active annotations</title><link rel="stylesheet" href="css/docbook.css" type="text/css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.75.2"><link rel="home" href="user_documentation.html" title="K3 User Documentation"><link rel="up" href="ch05.html" title="Chapter&nbsp;5.&nbsp;Implementation details"><link rel="prev" href="ch05.html" title="Chapter&nbsp;5.&nbsp;Implementation details"><base xmlns:fo="http://www.w3.org/1999/XSL/Format" target="body"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5.2.&nbsp;K3 Active annotations</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch05.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;5.&nbsp;Implementation details</th><td width="20%" align="right">&nbsp;</td></tr></table><hr></div><div class="section" title="5.2.&nbsp;K3 Active annotations"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_k3_active_annotations"></a>5.2.&nbsp;K3 Active annotations</h2></div></div></div><p><code class="literal">import static extension</code> is enough to contribute operations to a class, however we also often need to contribute fields.</p><p>To do so, K3 implement a set of <a class="link" href="http://www.eclipse.org/xtend/documentation/204_activeannotations.html" target="_top">Active annotations</a>. This kind of annoation allows to contribute to Xtend java code generator and rewrite a part of the resulting java code.</p><p>The <span class="strong"><strong>@Aspect</strong></span> annotation allows to generate a set of classes that declares static methods that will be made avialable thanks to the <code class="literal">import static extension</code>. This set of classes implements a pattern that allows to to store the fields defined in the aspects.</p><p>For every aspect class:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">it creates a class with static methods. It acts as the public interface for the aspect.</li><li class="listitem">It creates an <code class="literal">*AspectProperties</code> class that is the companion object that will store the attributes defined by aspect.</li><li class="listitem">It creates an <code class="literal">*AspectContext</code> class that defines the mapping between the base object and the companion object.</li></ul></div><div xmlns="http://www.w3.org/1999/xhtml" xmlns:fo="http://www.w3.org/1999/XSL/Format" class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Tip</h2><p xmlns="">The result of the compilation of Xtend and K3 annotations in plain java is visible in the <code class="literal">xtend-gen</code> folder.</p></div><div class="section" title="5.2.1.&nbsp;K3 Active annotations compilation example"><div class="titlepage"><div><div><h3 class="title"><a name="_k3_active_annotations_compilation_example"></a>5.2.1.&nbsp;K3 Active annotations compilation example</h3></div></div></div><p>Let&#8217;s consider the following K3 code that adds a String attribute to the <code class="literal">java.io.File</code> class:</p><pre class="programlisting"><b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">import</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">static</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">extension</b> k3project.SampleXMLFileAspect.*

<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color: darkred">@Aspect(className=java.io.File )</b>
<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">class</b> SampleXMLFileAspect {
	<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">public</b> String contentType = <i xmlns:fo="http://www.w3.org/1999/XSL/Format" style="color:blue" class="hl-string">""</i>
}
<i xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-comment" style="color: darkgreen">//[..]</i>
    <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">val</b> f = <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">new</b> File(<i xmlns:fo="http://www.w3.org/1999/XSL/Format" style="color:blue" class="hl-string">"toto.txt"</i>)
    f.contentType = <i xmlns:fo="http://www.w3.org/1999/XSL/Format" style="color:blue" class="hl-string">"txt"</i></pre><div xmlns="http://www.w3.org/1999/xhtml" xmlns:fo="http://www.w3.org/1999/XSL/Format" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p xmlns="">Obviously, this will also work for operations. Adding an attribute is simply a little bit more complex since from xtend point of view, it adds 2 methods: the getter and the setter</p></div><p>It will be compiled in 3 Java classes : <code class="literal">SampleXMLFileAspect</code>, <code class="literal">SampleXMLFileAspectFileAspectContext</code> and <code class="literal">SampleXMLFileAspectFileAspectProperties</code>.</p><p><code class="literal">SampleXMLFileAspect</code> is the public interface that declares all <code class="literal">public static</code> methods that are make available with the <code class="literal">import static extension</code>. A technical part is kept in private.</p><div xmlns="http://www.w3.org/1999/xhtml" xmlns:fo="http://www.w3.org/1999/XSL/Format" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p xmlns="">You can notice the systematic use of <span class="strong"><strong>_self</strong></span> as the first parameter of the static methods. This allows to access to the object instance from the bodies of aspect methods.</p></div><p><code class="literal">SampleXMLFileAspectFileAspectProperties</code> is the companion object that is associated to the base object.</p><p><code class="literal">SampleXMLFileAspectFileAspectContext</code> implements the map that allows to get the companion object <code class="literal">SampleXMLFileAspectFileAspectProperties</code> via the <span class="strong"><strong>_self</strong></span> keyword.</p><pre class="programlisting"><b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">public</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">class</b> SampleXMLFileAspectFileAspectProperties {
  <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">public</b> String contentType = <i xmlns:fo="http://www.w3.org/1999/XSL/Format" style="color:blue" class="hl-string">""</i>;
}</pre><pre class="programlisting"><b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">public</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">class</b> SampleXMLFileAspect {

  <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">public</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">static</b> String contentType(<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">final</b> File _self) { <a name="CO9-1"></a><img src="gfx/callouts/1.gif" alt="1" border="0">
    k3project.SampleXMLFileAspectFileAspectProperties _self_ = k3project.SampleXMLFileAspectFileAspectContext.getSelf(_self);
    Object result = null;
    result =_privk3_contentType(_self_, _self);
    <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">return</b> (java.lang.String)result;
  }

  <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">public</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">static</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">void</b> contentType(<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">final</b> File _self, <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">final</b> String contentType) { <a name="CO9-2"></a><img src="gfx/callouts/2.gif" alt="2" border="0">
    k3project.SampleXMLFileAspectFileAspectProperties _self_ = k3project.SampleXMLFileAspectFileAspectContext.getSelf(_self);
    _privk3_contentType(_self_, _self,contentType);
  }
    <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">protected</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">static</b> String _privk3_contentType(<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">final</b> SampleXMLFileAspectFileAspectProperties _self_, <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">final</b> File _self) {
    <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">try</b> { <a name="CO9-3"></a><img src="gfx/callouts/3.gif" alt="3" border="0">
    	<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">for</b> (java.lang.reflect.Method m : _self.getClass().getMethods()) {
    		<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">if</b> (m.getName().equals(<i xmlns:fo="http://www.w3.org/1999/XSL/Format" style="color:blue" class="hl-string">"getContentType"</i>) &amp;&amp;
    			m.getParameterTypes().length == <span class="hl-number">0</span>) {
    				Object ret = m.invoke(_self);
    				<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">if</b> (ret != null) {
    					<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">return</b> (java.lang.String) ret;
    				}
    		}
    	}
    } <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">catch</b> (Exception e) {
    	<i xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-comment" style="color: darkgreen">// Chut !</i>
    }
    <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">return</b> _self_.contentType;
  }

  <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">protected</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">static</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">void</b> _privk3_contentType(<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">final</b> SampleXMLFileAspectFileAspectProperties _self_, <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">final</b> File _self, <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">final</b> String contentType) { <a name="CO9-4"></a><img src="gfx/callouts/4.gif" alt="4" border="0">
    _self_.contentType = contentType; <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">try</b> {
    	<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">for</b> (java.lang.reflect.Method m : _self.getClass().getMethods()) {
    		<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">if</b> (m.getName().equals(<i xmlns:fo="http://www.w3.org/1999/XSL/Format" style="color:blue" class="hl-string">"setContentType"</i>)
    				&amp;&amp; m.getParameterTypes().length == <span class="hl-number">1</span>) {
    			m.invoke(_self, contentType);
    		}
    	}
    } <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">catch</b> (Exception e) {
    	<i xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-comment" style="color: darkgreen">// Chut !</i>
    }
  }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-1"><img src="gfx/callouts/1.gif" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>public getter operation seen from xtend</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-2"><img src="gfx/callouts/2.gif" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>public setter operation seen from xtend</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-3"><img src="gfx/callouts/3.gif" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>real getter code in the <span class="emphasis"><em>privk3</em></span> method</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-4"><img src="gfx/callouts/4.gif" alt="4" border="0"></a> </p></td><td valign="top" align="left"><p>real setter code in the <span class="emphasis"><em>privk3</em></span> method</p></td></tr></table></div><pre class="programlisting"><b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">public</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">class</b> SampleXMLFileAspectFileAspectContext {
  <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">public</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">final</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">static</b> SampleXMLFileAspectFileAspectContext INSTANCE = <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">new</b> SampleXMLFileAspectFileAspectContext();

  <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">public</b> <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">static</b> SampleXMLFileAspectFileAspectProperties getSelf(<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">final</b> File _self) {
    		<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">if</b> (!INSTANCE.map.containsKey(_self))
    			INSTANCE.map.put(_self, <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">new</b> k3project.SampleXMLFileAspectFileAspectProperties());
    		<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">return</b> INSTANCE.map.get(_self);
  }
  <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">private</b> Map<b class="hl-tag" style="color: #000096">&lt;File,</b> <span class="hl-attribute" style="color: #F5844C">ModuleAspectFileAspectProperties</span><b class="hl-tag" style="color: #000096"> &gt;</b> map =
  	<b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">new</b> java.util.WeakHashMap<b class="hl-tag" style="color: #000096">&lt;java.io.File,</b> <span class="hl-attribute" style="color: #F5844C">k3project.ModuleAspectFileAspectProperties</span><b class="hl-tag" style="color: #000096"> &gt;</b> ();

  <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">public</b> Map<b class="hl-tag" style="color: #000096">&lt;File,</b> <span class="hl-attribute" style="color: #F5844C">ModuleAspectFileAspectProperties&gt;</span> <span class="hl-attribute" style="color: #F5844C">getMap()</span> <span class="hl-attribute" style="color: #F5844C">{</span>
    <b xmlns:fo="http://www.w3.org/1999/XSL/Format" class="hl-keyword" style="color:darkblue">return</b> map;
  }

}</pre></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch05.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="ch05.html">Up</a></td><td width="40%" align="right">&nbsp;</td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;5.&nbsp;Implementation details&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="user_documentation.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;</td></tr></table></div></body></html>